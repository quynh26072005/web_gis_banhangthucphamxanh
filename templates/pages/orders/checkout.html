{% extends 'base/base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-credit-card"></i> {{ title }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'food_store:home' %}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'food_store:cart' %}">Giỏ hàng</a></li>
                    <li class="breadcrumb-item active">Thanh toán</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Delivery Address Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Địa chỉ giao hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="deliveryAddress" class="form-label">Địa chỉ chi tiết</label>
                        <textarea class="form-control" id="deliveryAddress" rows="3"
                            placeholder="Nhập địa chỉ chi tiết (số nhà, tên đường, phường/xã, quận/huyện...)"
                            required></textarea>
                        <small class="text-muted">Ví dụ: 123 Nguyễn Huệ, Phường Bến Nghé, Quận 1, TP.HCM</small>
                    </div>

                    <!-- Geolocation Button -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary" id="getCurrentLocationBtn">
                            <i class="fas fa-crosshairs"></i> Lấy vị trí hiện tại
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" id="geocodeAddressBtn">
                            <i class="fas fa-search-location"></i> Tìm từ địa chỉ
                        </button>
                    </div>

                    <!-- Hidden fields for coordinates -->
                    <input type="hidden" id="selectedLat" value="">
                    <input type="hidden" id="selectedLng" value="">

                    <!-- Location status display -->
                    <div id="locationStatus" class="alert alert-info" style="display: none;">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="locationText">Đang xác định vị trí...</span>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Lưu ý:</strong> Nhấn "Lấy vị trí hiện tại" hoặc "Tìm từ địa chỉ" để hệ thống tự động xác
                        định tọa độ giao hàng và tính phí chính xác.
                    </div>
                </div>
            </div>

            <!-- Order Notes -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Ghi chú đơn hàng</h5>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="orderNotes" rows="3"
                        placeholder="Ghi chú cho đơn hàng (tùy chọn)"></textarea>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tóm tắt đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Sản phẩm đã chọn:</h6>
                        {% for item in cart.items.all %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <small>{{ item.product.name }}</small>
                                <br>
                                <small class="text-muted">{{ item.quantity }} x {{ item.product.price|floatformat:0 }}
                                    VNĐ</small>
                            </div>
                            <small class="fw-bold">{{ item.total_price|floatformat:0 }} VNĐ</small>
                        </div>
                        {% endfor %}
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng tiền hàng:</span>
                        <span>{{ cart.total_amount|floatformat:0 }} VNĐ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí giao hàng:</span>
                        <span id="deliveryFee">30,000 VNĐ</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Tổng thanh toán:</strong>
                        <strong id="totalAmount">{{ cart.total_amount|add:30000|floatformat:0 }} VNĐ</strong>
                    </div>

                    <button class="btn btn-success w-100" id="placeOrderBtn">
                        <i class="fas fa-check"></i> Đặt hàng
                    </button>

                    <div class="text-center mt-3">
                        <a href="{% url 'food_store:cart' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Geolocation handler
    document.getElementById('getCurrentLocationBtn').addEventListener('click', function () {
        const statusDiv = document.getElementById('locationStatus');
        const statusText = document.getElementById('locationText');

        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-info';
        statusText.textContent = 'Đang lấy vị trí hiện tại...';

        if (!navigator.geolocation) {
            statusDiv.className = 'alert alert-danger';
            statusText.textContent = '❌ Trình duyệt không hỗ trợ định vị';
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                document.getElementById('selectedLat').value = lat;
                document.getElementById('selectedLng').value = lng;

                statusDiv.className = 'alert alert-success';
                statusText.innerHTML = `✓ Đã lấy vị trí: <strong>${lat.toFixed(6)}, ${lng.toFixed(6)}</strong>`;
            },
            function (error) {
                statusDiv.className = 'alert alert-danger';
                statusText.textContent = '❌ Không thể lấy vị trí: ' + error.message;
            }
        );
    });

    // Geocoding handler
    document.getElementById('geocodeAddressBtn').addEventListener('click', function () {
        const address = document.getElementById('deliveryAddress').value.trim();

        if (!address) {
            alert('Vui lòng nhập địa chỉ chi tiết trước');
            document.getElementById('deliveryAddress').focus();
            return;
        }

        const statusDiv = document.getElementById('locationStatus');
        const statusText = document.getElementById('locationText');

        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-info';
        statusText.textContent = 'Đang tìm tọa độ từ địa chỉ...';

        const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Vietnam')}&limit=1`;

        fetch(nominatimUrl, {
            headers: {
                'User-Agent': 'CleanFoodStore/1.0'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);

                    document.getElementById('selectedLat').value = lat;
                    document.getElementById('selectedLng').value = lng;

                    statusDiv.className = 'alert alert-success';
                    statusText.innerHTML = `✓ Tìm thấy: <strong>${data[0].display_name}</strong><br>Tọa độ: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                } else {
                    statusDiv.className = 'alert alert-warning';
                    statusText.textContent = '⚠ Không tìm thấy địa chỉ. Vui lòng nhập chi tiết hơn hoặc dùng "Lấy vị trí hiện tại".';
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                statusDiv.className = 'alert alert-danger';
                statusText.textContent = '❌ Lỗi khi tìm địa chỉ. Vui lòng thử lại.';
            });
    });

    // Place order
    document.getElementById('placeOrderBtn').addEventListener('click', function () {
        const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
        if (!deliveryAddress) {
            alert('Vui lòng nhập địa chỉ giao hàng');
            return;
        }

        const selectedLat = document.getElementById('selectedLat').value || 10.8231;
        const selectedLng = document.getElementById('selectedLng').value || 106.6297;
        const orderNotes = document.getElementById('orderNotes').value.trim();

        // Disable button and show loading
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

        fetch('{% url "food_store:create_order_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                latitude: parseFloat(selectedLat) || null,
                longitude: parseFloat(selectedLng) || null,
                delivery_address: deliveryAddress,
                notes: orderNotes
            })
        })
            .then(response => {
                // Check if response is OK (200-299)
                if (!response.ok) {
                    // Parse error message from server
                    return response.json().then(data => {
                        throw new Error(data.error || 'Có lỗi xảy ra');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Redirect to success page
                    window.location.href = '{% url "food_store:order_success" 0 %}'.replace('0', data.order_id);
                } else {
                    alert('Có lỗi xảy ra: ' + data.error);
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i> Đặt hàng';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || 'Có lỗi xảy ra khi đặt hàng');
                // Re-enable button
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check"></i> Đặt hàng';
            });
    });
</script>
{% endblock %}