{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-credit-card"></i> {{ title }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'food_store:home' %}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'food_store:cart' %}">Giỏ hàng</a></li>
                    <li class="breadcrumb-item active">Thanh toán</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Delivery Address Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Địa chỉ giao hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="deliveryAddress" class="form-label">Địa chỉ chi tiết</label>
                        <textarea class="form-control" id="deliveryAddress" rows="3" placeholder="Nhập địa chỉ chi tiết (số nhà, tên đường, phường/xã, quận/huyện...)"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn vị trí trên bản đồ</label>
                        <p class="text-muted small">Click trên bản đồ để chọn vị trí giao hàng chính xác</p>
                        <div id="deliveryMap" style="height: 400px; border: 1px solid #ddd; border-radius: 0.375rem;"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="selectedLat" class="form-label">Vĩ độ</label>
                            <input type="number" class="form-control" id="selectedLat" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="selectedLng" class="form-label">Kinh độ</label>
                            <input type="number" class="form-control" id="selectedLng" readonly>
                        </div>
                    </div>
                    
                    <div id="deliveryInfo" class="mt-3"></div>
                </div>
            </div>
            
            <!-- Order Notes -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Ghi chú đơn hàng</h5>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="orderNotes" rows="3" placeholder="Ghi chú cho đơn hàng (tùy chọn)"></textarea>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tóm tắt đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Sản phẩm đã chọn:</h6>
                        {% for item in cart.items.all %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <small>{{ item.product.name }}</small>
                                <br>
                                <small class="text-muted">{{ item.quantity }} x {{ item.product.price|floatformat:0 }} VNĐ</small>
                            </div>
                            <small class="fw-bold">{{ item.total_price|floatformat:0 }} VNĐ</small>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng tiền hàng:</span>
                        <span>{{ cart.total_amount|floatformat:0 }} VNĐ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí giao hàng:</span>
                        <span id="deliveryFee">Chưa xác định</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Tổng thanh toán:</strong>
                        <strong id="totalAmount">{{ cart.total_amount|floatformat:0 }} VNĐ</strong>
                    </div>
                    
                    <button class="btn btn-success w-100" id="placeOrderBtn" disabled>
                        <i class="fas fa-check"></i> Đặt hàng
                    </button>
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'food_store:cart' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let deliveryMap;
let selectedMarker;
let selectedLat = null;
let selectedLng = null;
let deliveryFeeAmount = 0;
const cartTotal = {{ cart.total_amount }};

// Initialize map
function initMap() {
    // Default to Ho Chi Minh City
    deliveryMap = L.map('deliveryMap').setView([10.8231, 106.6297], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(deliveryMap);
    
    // Add click event to map
    deliveryMap.on('click', function(e) {
        selectDeliveryLocation(e.latlng.lat, e.latlng.lng);
    });
    
    // Load delivery zones
    loadDeliveryZones();
}

// Load and display delivery zones
function loadDeliveryZones() {
    fetch('{% url "gis_tools:delivery_zones_geojson" %}')
    .then(response => response.json())
    .then(data => {
        L.geoJSON(data, {
            style: function(feature) {
                return {
                    color: '#007bff',
                    weight: 2,
                    fillColor: '#007bff',
                    fillOpacity: 0.1
                };
            },
            onEachFeature: function(feature, layer) {
                const props = feature.properties;
                layer.bindPopup(`
                    <strong>${props.name}</strong><br>
                    Phí giao hàng: ${props.delivery_fee.toLocaleString()} VNĐ<br>
                    Thời gian: ${props.delivery_time}
                `);
            }
        }).addTo(deliveryMap);
    })
    .catch(error => {
        console.error('Error loading delivery zones:', error);
    });
}

// Select delivery location
function selectDeliveryLocation(lat, lng) {
    selectedLat = lat;
    selectedLng = lng;
    
    // Update input fields
    document.getElementById('selectedLat').value = lat.toFixed(6);
    document.getElementById('selectedLng').value = lng.toFixed(6);
    
    // Remove existing marker
    if (selectedMarker) {
        deliveryMap.removeLayer(selectedMarker);
    }
    
    // Add new marker
    selectedMarker = L.marker([lat, lng], {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    }).addTo(deliveryMap);
    
    selectedMarker.bindPopup('Địa điểm giao hàng đã chọn').openPopup();
    
    // Check delivery availability
    checkDeliveryAvailability(lat, lng);
}

// Check delivery availability
function checkDeliveryAvailability(lat, lng) {
    const deliveryInfoDiv = document.getElementById('deliveryInfo');
    deliveryInfoDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang kiểm tra khả năng giao hàng...</div>';
    
    fetch('{% url "gis_tools:check_delivery_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            latitude: lat,
            longitude: lng
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const info = data.delivery_info;
            if (info.can_deliver) {
                deliveryFeeAmount = info.delivery_fee;
                const totalAmount = cartTotal + deliveryFeeAmount;
                
                deliveryInfoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Có thể giao hàng</h6>
                        <p><strong>Khu vực:</strong> ${info.zone_name}</p>
                        <p><strong>Phí giao hàng:</strong> ${info.delivery_fee.toLocaleString()} VNĐ</p>
                        <p><strong>Thời gian:</strong> ${info.delivery_time}</p>
                    </div>
                `;
                
                // Update order summary
                document.getElementById('deliveryFee').textContent = info.delivery_fee.toLocaleString() + ' VNĐ';
                document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' VNĐ';
                
                // Enable place order button
                document.getElementById('placeOrderBtn').disabled = false;
            } else {
                deliveryInfoDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-times-circle"></i> Không thể giao hàng</h6>
                        <p>Địa điểm này nằm ngoài khu vực giao hàng của chúng tôi.</p>
                    </div>
                `;
                
                // Disable place order button
                document.getElementById('placeOrderBtn').disabled = true;
                deliveryFeeAmount = 0;
            }
        } else {
            deliveryInfoDiv.innerHTML = `<div class="alert alert-danger">Lỗi: ${data.error}</div>`;
            document.getElementById('placeOrderBtn').disabled = true;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        deliveryInfoDiv.innerHTML = '<div class="alert alert-danger">Có lỗi xảy ra khi kiểm tra giao hàng</div>';
        document.getElementById('placeOrderBtn').disabled = true;
    });
}

// Place order
document.getElementById('placeOrderBtn').addEventListener('click', function() {
    if (!selectedLat || !selectedLng) {
        alert('Vui lòng chọn địa điểm giao hàng trên bản đồ');
        return;
    }
    
    const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
    if (!deliveryAddress) {
        alert('Vui lòng nhập địa chỉ chi tiết');
        return;
    }
    
    const orderNotes = document.getElementById('orderNotes').value.trim();
    
    // Disable button and show loading
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
    
    fetch('{% url "food_store:create_order_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            latitude: selectedLat,
            longitude: selectedLng,
            delivery_address: deliveryAddress,
            notes: orderNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to success page
            window.location.href = '{% url "food_store:order_success" 0 %}'.replace('0', data.order_id);
        } else {
            alert('Có lỗi xảy ra: ' + data.error);
            // Re-enable button
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> Đặt hàng';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi đặt hàng');
        // Re-enable button
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check"></i> Đặt hàng';
    });
});

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});
</script>
{% endblock %}