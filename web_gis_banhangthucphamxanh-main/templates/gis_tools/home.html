{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4"><i class="fas fa-map text-primary"></i> Công cụ GIS</h1>
            <p class="lead text-muted">Hệ thống thông tin địa lý cho Website Thực phẩm Sạch</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-5">
        <div class="col-md-4 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-home fa-3x mb-3"></i>
                    <h3>{{ total_farms }}</h3>
                    <p class="mb-0">Trang trại</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                    <h3>{{ total_zones }}</h3>
                    <p class="mb-0">Khu vực giao hàng</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <h3>{{ total_orders }}</h3>
                    <p class="mb-0">Đơn hàng</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GIS Tools Grid -->
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-map-marker-alt fa-3x text-success mb-3"></i>
                    <h4 class="card-title">Bản đồ Trang trại</h4>
                    <p class="card-text">Xem vị trí tất cả trang trại trên bản đồ tương tác. Tìm hiểu thông tin chi tiết
                        về từng trang trại.</p>
                    <a href="{% url 'gis_tools:farms_map' %}" class="btn btn-success">
                        <i class="fas fa-eye"></i> Xem bản đồ
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-shipping-fast fa-3x text-info mb-3"></i>
                    <h4 class="card-title">Khu vực Giao hàng</h4>
                    <p class="card-text">Hiển thị các khu vực giao hàng với thông tin phí và thời gian giao hàng.</p>
                    <a href="{% url 'gis_tools:delivery_zones_map' %}" class="btn btn-info">
                        <i class="fas fa-eye"></i> Xem khu vực
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-chart-bar fa-3x text-warning mb-3"></i>
                    <h4 class="card-title">Phân tích Dữ liệu</h4>
                    <p class="card-text">Dashboard phân tích dữ liệu bán hàng theo địa lý và thống kê trang trại.</p>
                    <a href="{% url 'gis_tools:analytics_dashboard' %}" class="btn btn-warning">
                        <i class="fas fa-chart-line"></i> Xem phân tích
                    </a>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 border-success">
                    <div class="card-body text-center">
                        <i class="fas fa-search-location fa-3x text-success mb-3"></i>
                        <h4 class="card-title">Tìm quanh đây</h4>
                        <p class="card-text">Sử dụng vị trí của bạn để tìm các trang trại sạch gần nhất. Tiết kiệm thời
                            gian và phí vận chuyển.</p>
                        <a href="{% url 'gis_tools:store_locator' %}" class="btn btn-outline-success">
                            <i class="fas fa-crosshairs"></i> Tìm trang trại
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Tools Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h2 class="mb-4"><i class="fas fa-cogs"></i> Công cụ API GIS</h2>
            <p class="text-muted mb-4">Các API để tích hợp chức năng GIS vào ứng dụng</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-search-location"></i> Tìm Trang trại Gần nhất</h5>
                </div>
                <div class="card-body">
                    <p>Nhập tọa độ để tìm các trang trại gần nhất:</p>
                    <form id="findFarmsForm">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="latitude" placeholder="Vĩ độ" step="any"
                                    value="10.8231">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="longitude" placeholder="Kinh độ"
                                    step="any" value="106.6297">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
                            </div>
                        </div>
                    </form>
                    <div id="farmsResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-truck"></i> Kiểm tra Giao hàng</h5>
                </div>
                <div class="card-body">
                    <p>Kiểm tra khả năng giao hàng đến địa điểm:</p>
                    <form id="checkDeliveryForm">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="deliveryLat" placeholder="Vĩ độ"
                                    step="any" value="10.8231">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="deliveryLng" placeholder="Kinh độ"
                                    step="any" value="106.6297">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-success w-100">Kiểm tra</button>
                            </div>
                        </div>
                    </form>
                    <div id="deliveryResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Geocoding Tool -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-map-pin"></i> Chuyển đổi Địa chỉ</h5>
                </div>
                <div class="card-body">
                    <p>Chuyển đổi địa chỉ thành tọa độ:</p>
                    <form id="geocodeForm">
                        <div class="row">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="address"
                                    placeholder="Nhập địa chỉ (VD: 123 Nguyễn Huệ, Quận 1, TP.HCM)"
                                    value="Quận 1, TP.HCM">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-info w-100">Chuyển đổi</button>
                            </div>
                        </div>
                    </form>
                    <div id="geocodeResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Find nearest farms
    document.getElementById('findFarmsForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const lat = document.getElementById('latitude').value;
        const lng = document.getElementById('longitude').value;
        const resultDiv = document.getElementById('farmsResult');

        if (!lat || !lng) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Vui lòng nhập đầy đủ tọa độ</div>';
            return;
        }

        resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tìm kiếm...</div>';

        fetch('{% url "gis_tools:find_nearest_farms_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                max_distance: 50
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `<div class="alert alert-success">Tìm thấy ${data.total_found} trang trại:</div>`;
                    if (data.farms.length > 0) {
                        html += '<div class="list-group">';
                        data.farms.forEach(farm => {
                            html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${farm.name}</h6>
                                <small class="text-success">${farm.distance_km} km</small>
                            </div>
                            <p class="mb-1">${farm.address}</p>
                            <small>${farm.organic_certified ? '<i class="fas fa-leaf text-success"></i> Hữu cơ' : ''}</small>
                        </div>
                    `;
                        });
                        html += '</div>';
                    }
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Lỗi: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert alert-danger">Có lỗi xảy ra khi tìm kiếm</div>';
            });
    });

    // Check delivery availability
    document.getElementById('checkDeliveryForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const lat = document.getElementById('deliveryLat').value;
        const lng = document.getElementById('deliveryLng').value;
        const resultDiv = document.getElementById('deliveryResult');

        if (!lat || !lng) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Vui lòng nhập đầy đủ tọa độ</div>';
            return;
        }

        resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...</div>';

        fetch('{% url "gis_tools:check_delivery_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const info = data.delivery_info;
                    if (info.can_deliver) {
                        resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Có thể giao hàng</h6>
                        <p><strong>Khu vực:</strong> ${info.zone_name}</p>
                        <p><strong>Phí giao hàng:</strong> ${info.delivery_fee.toLocaleString()} VNĐ</p>
                        <p><strong>Thời gian:</strong> ${info.delivery_time}</p>
                    </div>
                `;
                    } else {
                        resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-times-circle"></i> Không thể giao hàng</h6>
                        <p>Địa điểm này nằm ngoài khu vực giao hàng của chúng tôi.</p>
                    </div>
                `;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Lỗi: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert alert-danger">Có lỗi xảy ra khi kiểm tra</div>';
            });
    });

    // Geocode address
    document.getElementById('geocodeForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const address = document.getElementById('address').value.trim();
        const resultDiv = document.getElementById('geocodeResult');

        if (!address) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Vui lòng nhập địa chỉ</div>';
            return;
        }

        resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang chuyển đổi...</div>';

        fetch('{% url "gis_tools:geocode_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                address: address
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const coords = data.coordinates;
                    resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-map-marker-alt"></i> Tọa độ tìm được:</h6>
                    <p><strong>Vĩ độ:</strong> ${coords.latitude}</p>
                    <p><strong>Kinh độ:</strong> ${coords.longitude}</p>
                </div>
            `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Lỗi: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert alert-danger">Có lỗi xảy ra khi chuyển đổi</div>';
            });
    });
</script>
{% endblock %}